name: Python Wheels Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump for python/opaque_ke_py/Cargo.toml
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
      release_body:
        description: Optional custom release body (Markdown). Leave empty for generated notes only.
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare release
    runs-on: ubuntu-latest
    outputs:
      bump: ${{ steps.bump.outputs.bump }}
      previous_version: ${{ steps.bump.outputs.previous_version }}
      new_version: ${{ steps.bump.outputs.new_version }}
      tag: ${{ steps.bump.outputs.tag }}
      release_sha: ${{ steps.commit.outputs.release_sha }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump python crate version
        id: bump
        env:
          BUMP: ${{ inputs.bump }}
        run: |
          python <<'PY'
          import os
          import pathlib
          import re
          import sys

          bump = os.environ["BUMP"].strip().lower()
          if bump not in {"patch", "minor", "major"}:
              print(
                  f"::error title=Unsupported bump::'{bump}' is invalid. Choose one of: patch, minor, major.",
                  file=sys.stderr,
              )
              sys.exit(1)

          path = pathlib.Path("python/opaque_ke_py/Cargo.toml")
          text = path.read_text(encoding="utf-8")

          package_match = re.search(r"(?ms)^\[package\]\n(?P<body>.*?)(?=^\[|\Z)", text)
          if not package_match:
              print(
                  "::error title=Version bump failed::Could not find [package] in python/opaque_ke_py/Cargo.toml.",
                  file=sys.stderr,
              )
              sys.exit(1)

          body = package_match.group("body")
          version_match = re.search(
              r'(?m)^version\s*=\s*"(?P<major>\d+)\.(?P<minor>\d+)\.(?P<patch>\d+)"\s*$',
              body,
          )
          if not version_match:
              print(
                  "::error title=Version bump failed::Could not find a SemVer package version (X.Y.Z).",
                  file=sys.stderr,
              )
              sys.exit(1)

          major = int(version_match.group("major"))
          minor = int(version_match.group("minor"))
          patch = int(version_match.group("patch"))
          previous_version = f"{major}.{minor}.{patch}"

          if bump == "patch":
              patch += 1
          elif bump == "minor":
              minor += 1
              patch = 0
          else:
              major += 1
              minor = 0
              patch = 0

          new_version = f"{major}.{minor}.{patch}"
          tag = f"python-v{new_version}"

          new_body = (
              body[: version_match.start()]
              + f'version = "{new_version}"\n'
              + body[version_match.end() :]
          )
          new_text = (
              text[: package_match.start("body")]
              + new_body
              + text[package_match.end("body") :]
          )
          path.write_text(new_text, encoding="utf-8")

          with pathlib.Path(os.environ["GITHUB_OUTPUT"]).open("a", encoding="utf-8") as fh:
              fh.write(f"bump={bump}\n")
              fh.write(f"previous_version={previous_version}\n")
              fh.write(f"new_version={new_version}\n")
              fh.write(f"tag={tag}\n")

          print(f"Bumped python version: {previous_version} -> {new_version}")
          PY

      - name: Commit, tag, and push
        id: commit
        env:
          TAG: ${{ steps.bump.outputs.tag }}
        run: |
          git fetch origin main --tags
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" > /dev/null; then
            echo "::error title=Tag already exists::${TAG} already exists. Re-run with a larger bump type."
            exit 1
          fi

          if git diff --quiet -- python/opaque_ke_py/Cargo.toml; then
            echo "::error title=No version change::python/opaque_ke_py/Cargo.toml was not changed."
            exit 1
          fi

          git add python/opaque_ke_py/Cargo.toml
          git commit -m "python: release ${TAG}"
          git tag -a "${TAG}" -m "Python wheel release ${TAG}"
          git push origin HEAD:main "${TAG}"
          echo "release_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build-wheels:
    name: Build ${{ matrix.name }}
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            python-version: "3.11"
            host_target: x86_64-unknown-linux-gnu
            target: x86_64-unknown-linux-gnu
          - name: linux-aarch64
            os: ubuntu-24.04-arm
            python-version: "3.11"
            host_target: aarch64-unknown-linux-gnu
            target: aarch64-unknown-linux-gnu
          - name: windows-x86_64
            os: windows-latest
            python-version: "3.11"
            host_target: x86_64-pc-windows-msvc
            target: x86_64-pc-windows-msvc
          - name: windows-aarch64
            os: windows-latest
            python-version: "3.11"
            host_target: x86_64-pc-windows-msvc
            target: aarch64-pc-windows-msvc
          - name: macos-x86_64
            os: macos-15-intel
            python-version: "3.11"
            host_target: x86_64-apple-darwin
            target: x86_64-apple-darwin
          - name: macos-aarch64
            os: macos-14
            python-version: "3.11"
            host_target: aarch64-apple-darwin
            target: aarch64-apple-darwin
    steps:
      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.release_sha }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: matrix.target != matrix.host_target
        run: rustup target add ${{ matrix.target }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install maturin
        run: python -m pip install -U pip maturin

      - name: Ensure LLVM binutils for Windows ARM64 cross-build
        if: matrix.target == 'aarch64-pc-windows-msvc'
        shell: pwsh
        run: |
          if (-not (Get-Command llvm-dlltool -ErrorAction SilentlyContinue)) {
            choco install llvm --yes --no-progress
          }
          llvm-dlltool --version

      - name: Build wheel (Linux)
        if: runner.os == 'Linux'
        working-directory: python/opaque_ke_py
        run: |
          python -m maturin build --release --out ../dist --target ${{ matrix.target }}

      - name: Build wheel (Non-Linux)
        if: runner.os != 'Linux'
        working-directory: python/opaque_ke_py
        run: python -m maturin build --release --out ../dist --target ${{ matrix.target }}

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: abi3-wheels-${{ matrix.name }}
          path: python/dist/*.whl
          if-no-files-found: error

  publish-release:
    name: Publish release
    needs: [prepare-release, build-wheels]
    runs-on: ubuntu-latest
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: abi3-wheels-*
          path: python/dist
          merge-multiple: true

      - name: Create GitHub release and upload wheels
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: ${{ needs.prepare-release.outputs.tag }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            python/dist/*.whl
          body: ${{ inputs.release_body }}
